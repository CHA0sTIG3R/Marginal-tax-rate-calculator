name: Deploy

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
  workflow_dispatch:
    inputs:
      run_import:
        description: "Run one-off data import before deploy"
        type: boolean
        required: false
        default: false

jobs:
  deploy:
    # Run when CI succeeded on default branch, or when manually triggered
    if: >-
      ${{ (github.event_name == 'workflow_run' &&
            github.event.workflow_run.conclusion == 'success' &&
            github.event.workflow_run.head_branch == 'master') ||
           (github.event_name == 'workflow_dispatch') }}
    runs-on: ubuntu-latest
    permissions:
      id-token: write   # for OIDC
      contents: read
    env:
      AWS_REGION: us-east-1
      ECR_REPO: tax-api
      APP_DIR: /home/ec2-user/tax-api
      TARGET_TAG_KEY: Service
      TARGET_TAG_VALUE: tax-api
    steps:
      - name: Checkout tested commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.sha }}
          fetch-depth: 0

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::300536313917:role/GitHubOIDCRole
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify EC2 tag targets
        shell: bash
        run: |
          set -euo pipefail
          COUNT=$(aws ec2 describe-instances \
            --filters "Name=tag:${TARGET_TAG_KEY},Values=${TARGET_TAG_VALUE}" "Name=instance-state-name,Values=running" \
            --query "Reservations[].Instances[].InstanceId" --output text | wc -w)
          if [ "${COUNT}" -eq 0 ]; then
            echo "No running EC2 instances found with tag ${TARGET_TAG_KEY}=${TARGET_TAG_VALUE} in ${AWS_REGION}." >&2
            echo "Tag your instance(s) or adjust TARGET_TAG_* in the workflow env." >&2
            exit 1
          fi
          echo "Found ${COUNT} running instance(s) with tag ${TARGET_TAG_KEY}=${TARGET_TAG_VALUE}."

      - name: Ensure ECR repo exists
        id: ecr
        shell: bash
        run: |
          set -euo pipefail
          aws ecr describe-repositories --repository-names "$ECR_REPO" || \
          aws ecr create-repository --repository-name "$ECR_REPO"
          ECR_URI=$(aws ecr describe-repositories \
            --repository-names "$ECR_REPO" \
            --query 'repositories[0].repositoryUri' \
            --output text)
          echo "repositoryUri=$ECR_URI" >> "$GITHUB_OUTPUT"
          # Export registry for later steps and SSM
          echo "ECR_URI=$ECR_URI" >> "$GITHUB_ENV"
          echo "ECR_REGISTRY=${ECR_URI%/*}" >> "$GITHUB_ENV"

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Decide whether to run data import
        id: import
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ inputs.run_import }}" = "true" ]; then
            echo "run_import=true" >> "$GITHUB_OUTPUT"
          else
            echo "run_import=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Determine if image-relevant files changed
        id: changes
        shell: bash
        run: |
          set -euo pipefail
          HEAD_SHA=${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.sha }}
          BASE_SHA=$(git rev-parse "${HEAD_SHA}^" 2>/dev/null || true)
          if [ -z "$BASE_SHA" ]; then
            echo "No base commit; building by default." >&2
            echo "should_build=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          CHANGED=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA")
          echo "$CHANGED" >&2
          if echo "$CHANGED" | grep -E '^(Dockerfile|\\.dockerignore|pom\\.xml|src/|docker-compose\\.yml)'; then
            echo "should_build=true" >> "$GITHUB_OUTPUT"
          else
            echo "should_build=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Build and push image to ECR
        if: steps.changes.outputs.should_build == 'true'
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64
          provenance: false
          push: true
          tags: |
            ${{ steps.ecr.outputs.repositoryUri }}:${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.sha }}
            ${{ steps.ecr.outputs.repositoryUri }}:prod
          cache-from: type=gha
          cache-to: type=gha,mode=max
        env:
          AWS_REGION: ${{ env.AWS_REGION }}

      - name: Skip build (no relevant changes)
        if: steps.changes.outputs.should_build != 'true'
        run: echo "No Docker/app changes detected. Skipping image build."

      - name: Run one-off data import on EC2 (when requested)
        if: steps.import.outputs.run_import == 'true'
        shell: bash
        run: |
          set -euo pipefail
          CMD_ID=$(aws ssm send-command \
            --targets "Key=tag:${TARGET_TAG_KEY},Values=${TARGET_TAG_VALUE}" \
            --document-name "AWS-RunShellScript" \
            --comment "Run data-import once (idempotent)" \
            --timeout-seconds 1200 \
            --parameters '{"commands":["set -e","cd '"${APP_DIR}"'","pwd","ls -la","docker compose version","aws ecr get-login-password --region '"${AWS_REGION}"' | docker login --username AWS --password-stdin '"${ECR_REGISTRY}"'","timeout 900 docker compose run --rm -e SPRING_PROFILES_ACTIVE=data-import -e TAX_IMPORT_ON_STARTUP=true -e SPRING_MAIN_WEB_APPLICATION_TYPE=none tax_data"]}' \
            --region "$AWS_REGION" \
            --query 'Command.CommandId' --output text)
          echo "Import CommandId: $CMD_ID"
          # Poll until import completes on all targets
          for i in $(seq 1 120); do
            STATUS=$(aws ssm list-command-invocations --command-id "$CMD_ID" --details --query 'CommandInvocations[].Status' --output text)
            echo "Import status: $STATUS"
            if echo "$STATUS" | grep -qE 'Success'; then exit 0; fi
            if echo "$STATUS" | grep -qE 'Failed|Cancelled|TimedOut'; then echo "Import failed with status: $STATUS" >&2; exit 1; fi
            sleep 5
          done
          echo "Import timed out waiting for completion" >&2
          exit 1

      - name: Deploy on EC2 via SSM
        if: steps.changes.outputs.should_build == 'true' || steps.import.outputs.run_import == 'true'
        shell: bash
        run: |
          set -euo pipefail
          aws ssm send-command \
            --targets "Key=tag:${TARGET_TAG_KEY},Values=${TARGET_TAG_VALUE}" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy tax-api" \
            --timeout-seconds 1200 \
            --parameters '{"commands":["set -e","cd '"${APP_DIR}"'","pwd","ls -la","docker compose version","aws ecr get-login-password --region '"${AWS_REGION}"' | docker login --username AWS --password-stdin '"${ECR_REGISTRY}"'","docker compose pull","docker compose up -d --force-recreate","docker compose ps","curl -sf http://127.0.0.1:8080/actuator/health || (docker compose logs --no-log-prefix --since 10m && exit 1)"]}' \
            --region "$AWS_REGION" \
            --output text
