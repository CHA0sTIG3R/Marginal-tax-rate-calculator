name: Deploy

on:
  workflow_dispatch:
  push:
  pull_request:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write   # for OIDC
      contents: read
    env:
      AWS_REGION: us-east-1
      ECR_REPO: tax-api
      APP_DIR: /home/ec2-user/tax-api
      TARGET_TAG_KEY: Service
      TARGET_TAG_VALUE: tax-api
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::300536313917:role/GitHubOIDCRole
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify EC2 tag targets
        shell: bash
        run: |
          set -euo pipefail
          COUNT=$(aws ec2 describe-instances \
            --filters "Name=tag:${TARGET_TAG_KEY},Values=${TARGET_TAG_VALUE}" "Name=instance-state-name,Values=running" \
            --query "Reservations[].Instances[].InstanceId" --output text | wc -w)
          if [ "${COUNT}" -eq 0 ]; then
            echo "No running EC2 instances found with tag ${TARGET_TAG_KEY}=${TARGET_TAG_VALUE} in ${AWS_REGION}." >&2
            echo "Tag your instance(s) or adjust TARGET_TAG_* in the workflow env." >&2
            exit 1
          fi
          echo "Found ${COUNT} running instance(s) with tag ${TARGET_TAG_KEY}=${TARGET_TAG_VALUE}."

      - name: Ensure ECR repo exists
        id: ecr
        shell: bash
        run: |
          set -euo pipefail
          aws ecr describe-repositories --repository-names "$ECR_REPO" || \
          aws ecr create-repository --repository-name "$ECR_REPO"
          ECR_URI=$(aws ecr describe-repositories \
            --repository-names "$ECR_REPO" \
            --query 'repositories[0].repositoryUri' \
            --output text)
          echo "repositoryUri=$ECR_URI" >> "$GITHUB_OUTPUT"
          # Export registry for later steps and SSM
          echo "ECR_URI=$ECR_URI" >> "$GITHUB_ENV"
          echo "ECR_REGISTRY=${ECR_URI%/*}" >> "$GITHUB_ENV"

      - name: Build and push image to ECR
        env:
          ECR_URI: ${{ steps.ecr.outputs.repositoryUri }}
        shell: bash
        run: |
          set -euo pipefail
          GIT_SHA=${GITHUB_SHA::7}
          aws ecr get-login-password --region "$AWS_REGION" | docker login --username AWS --password-stdin "${ECR_URI%/*}"
          # Build with cache and versioned tags, push directly
          # Uses registry cache at $ECR_URI:buildcache for speed
          docker buildx build \
            --platform linux/amd64 \
            --provenance=false \
            --cache-from type=registry,ref="$ECR_URI:buildcache" \
            --cache-to type=registry,ref="$ECR_URI:buildcache",mode=max \
            -t "$ECR_URI:$GIT_SHA" \
            -t "$ECR_URI:prod" \
            -t "$ECR_URI:latest" \
            --push .
          echo "IMAGE_URI=$ECR_URI:$GIT_SHA" >> "$GITHUB_ENV"

      - name: Run one-off data import on EC2
        shell: bash
        run: |
          set -euo pipefail
          aws ssm send-command \
            --targets "Key=tag:${TARGET_TAG_KEY},Values=${TARGET_TAG_VALUE}" \
            --document-name "AWS-RunShellScript" \
            --comment "Run data-import once (idempotent)" \
            --parameters '{"commands":["set -e","cd '"${APP_DIR}"'","aws ecr get-login-password --region '"${AWS_REGION}"' | docker login --username AWS --password-stdin '"${ECR_REGISTRY}"'","docker compose run --rm -e SPRING_PROFILES_ACTIVE=data-import tax_data"]}' \
            --region "$AWS_REGION" \
            --output text

      - name: Deploy on EC2 via SSM
        shell: bash
        run: |
          set -euo pipefail
          aws ssm send-command \
            --targets "Key=tag:${TARGET_TAG_KEY},Values=${TARGET_TAG_VALUE}" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy tax-api" \
            --parameters '{"commands":["set -e","cd '"${APP_DIR}"'","aws ecr get-login-password --region '"${AWS_REGION}"' | docker login --username AWS --password-stdin '"${ECR_REGISTRY}"'","docker compose pull","docker compose up -d"]}' \
            --region "$AWS_REGION" \
            --output text
